<!doctype html>
<html lang="zh-CN">
 <head>
  <meta charset="utf-8">
  <link rel="canonical" href="https://blog.csdn.net/wangkaidehao/article/details/104597626">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="report" content="{&quot;pid&quot;: &quot;blog&quot;, &quot;spm&quot;:&quot;1001.2101&quot;}">
  <meta name="referrer" content="always">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <link rel="alternate" media="handheld" href="#">
  <meta name="shenma-site-verification" content="5a59773ab8077d4a62bf469ab966a63b_1497598848">
  <meta name="applicable-device" content="pc">
  <link href="https://g.csdnimg.cn/static/logo/favicon32.ico" rel="shortcut icon" type="image/x-icon">
  <title>MAML模型无关的元学习代码完整复现（Pytorch版）-CSDN博客</title>
  <meta name="keywords" content="元学习代码">
  <meta name="csdn-baidu-search" content="{&quot;autorun&quot;:true,&quot;install&quot;:true,&quot;keyword&quot;:&quot;元学习代码&quot;}">
  <meta name="description" content="文章浏览阅读2.2w次，点赞32次，收藏276次。1 引言元学习是今年来新起的一种深度学习任务，它主要是想训练出具有强学习能力的神经网络。元学习领域一开始是一个小众的领域，之前很多年都没有很好的进展，直到Finn, C.在就读博士期间发表了一篇元学习的论文，也就是大名鼎鼎的MAML，它在回归，分类，强化学习三个任务上都达到了当时最好的性能。我曾经在半年前发表过一篇MAML的学习笔记，博文地址点这里。MAML出现之后算是掀起来了一波研究元学习..._元学习代码">
  <link rel="stylesheet" type="text/css" href="https://csdnimg.cn/release/blogv2/dist/pc/css/detail_enter-38ddee24dc.min.css">
  <link rel="stylesheet" type="text/css" href="https://csdnimg.cn/release/blogv2/dist/pc/themesSkin/skin3-template/skin3-template-762f7595fd.min.css">
  <meta name="toolbar" content="{&quot;type&quot;:&quot;0&quot;,&quot;fixModel&quot;:&quot;1&quot;}">
  <link rel="stylesheet" type="text/css" href="https://csdnimg.cn/public/sandalstrap/1.4/css/sandalstrap.min.css">
  <style>
        .MathJax, .MathJax_Message, .MathJax_Preview{
            display: none
        }
    </style>
 </head>
 <body class="nodata " style="">
  <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/pc/css/blog_code-01256533b5.min.css">
  <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/chart-3456820cac.css">
  <link rel="stylesheet" href="https://g.csdnimg.cn/lib/swiper/6.0.4/css/swiper.css"><div class="main_father clearfix d-flex justify-content-center mainfather-concision" style="height:100%;"><div class="container clearfix container-concision" id="mainBox">
    <main>
     <div class="blog-content-box"><div class="article-header-box"><div class="article-header"><div class="article-title-box">
         <h1 class="title-article" id="articleContentId">MAML模型无关的元学习代码完整复现（Pytorch版）</h1></div><div class="article-info-box"><div class="article-bar-top"><img class="article-type-img" src="https://csdnimg.cn/release/blogv2/dist/pc/img/original.png" alt=""><div class="bar-content"><img class="article-vip-img article-heard-img" src="https://csdnimg.cn/release/blogv2/dist/pc/img/identityVip.png" alt=""> <span class="article-vip-text vip_article"> VIP文章</span> <a class="follow-nickName " href="https://blog.csdn.net/wangkaidehao" target="_blank" rel="noopener" title="miguemath">miguemath</a> <img class="article-time-img article-heard-img" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newCurrentTime2.png" alt=""> <span class="time">于&nbsp;2020-03-01 19:42:29&nbsp;发布</span>
           <div class="read-count-box"><img class="article-read-img article-heard-img" src="https://csdnimg.cn/release/blogv2/dist/pc/img/articleReadEyes2.png" alt=""> <span class="read-count">阅读量2.2w</span> <a id="blog_detail_zk_collection" class="un-collection" data-report-click="{&quot;mod&quot;:&quot;popu_823&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4232&quot;,&quot;ab&quot;:&quot;new&quot;}"> <img class="article-collect-img article-heard-img un-collect-status isdefault" style="display:inline-block" src="https://csdnimg.cn/release/blogv2/dist/pc/img/tobarCollect2.png" alt=""> <img class="article-collect-img article-heard-img collect-status isactive" style="display:none" src="https://csdnimg.cn/release/blogv2/dist/pc/img/tobarCollectionActive2.png" alt=""> <span class="name">收藏</span> <span class="get-collection"> 276 </span> </a>
            <div class="read-count-box is-like"><img class="article-read-img article-heard-img" style="display:none" id="is-like-imgactive-new" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newHeart2023Active.png" alt=""> <img class="article-read-img article-heard-img" style="display:block" id="is-like-img-new" src="https://csdnimg.cn/release/blogv2/dist/pc/img/newHeart2023Black.png" alt=""> <span class="read-count" id="blog-digg-num">点赞数 32 </span></div></div></div></div><div class="blog-tags-box"><div class="tags-box artic-tag-box"><span class="label">分类专栏：</span> <a class="tag-link" href="https://blog.csdn.net/wangkaidehao/category_9703791.html" target="_blank" rel="noopener">Pytorch</a> <a class="tag-link" href="https://blog.csdn.net/wangkaidehao/category_9635229.html" target="_blank" rel="noopener">元学习</a> <span class="label">文章标签：</span> <a rel="nofollow" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;pytorch&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;pytorch\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=pytorch&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=" target="_blank">pytorch</a> <a rel="nofollow" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;神经网络&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;神经网络\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=" target="_blank">神经网络</a> <a rel="nofollow" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;深度学习&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;深度学习\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=" target="_blank">深度学习</a> <a rel="nofollow" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;人工智能&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;人工智能\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=" target="_blank">人工智能</a> <a rel="nofollow" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;过拟合&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;过拟合\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=%E8%BF%87%E6%8B%9F%E5%90%88&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=" target="_blank">过拟合</a></div></div><div class="slide-content-box"><div class="article-copyright"><div class="creativecommons">
            版权声明：本文为博主原创文章，遵循<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener"> CC 4.0 BY-SA </a>版权协议，转载请附上原文出处链接和本声明。</div><div class="article-source-link">
            本文链接：<a href="https://blog.csdn.net/wangkaidehao/article/details/104597626" target="_blank">https://blog.csdn.net/wangkaidehao/article/details/104597626</a></div></div></div><div class="operating"><a class="href-article-edit slide-toggle">版权</a></div></div></div></div><div id="blogHuaweiyunAdvert"></div>
      <article class="baidu_pl"><div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-044f2cf1dc.css"><div id="content_views" class="markdown_views prism-github-gist">
         <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
         </svg>
         <h2><a id="1__0"></a>1 引言</h2>
         <p>元学习是今年来新起的一种深度学习任务，它主要是想训练出具有强学习能力的神经网络。元学习领域一开始是一个小众的领域，之前很多年都没有很好的进展，直到Finn, C.在就读博士期间发表了一篇元学习的论文，也就是大名鼎鼎的MAML，它在回归，分类，强化学习三个任务上都达到了当时最好的性能。</p>
         <p>我曾经在半年前发表过一篇MAML的学习笔记，博文地址点<a href="https://blog.csdn.net/wangkaidehao/article/details/103110728">这里</a>。</p>
         <p>MAML出现之后算是掀起来了一波研究元学习的浪潮，此后改编MAML的论文层出不穷，但都没有实质性的突破。接下来我将引用我学习笔记中的语句来简要介绍一下MAML。</p>
         <blockquote>
          <p>MAML主要是学习出模型的初始参数，使得这个参数在新任务上经过少量的迭代更新之后就能使模型达到最好的效果。过去的方法一般是学习出一个迭代函数或者一个学习规则。MAML没有新增参数，也没有对模型提出任何约束。MAML可以看作是最大化损失函数在新任务上的灵敏度，从而当参数只有很小的改编时，损失函数也能大幅减小。</p>
         </blockquote>
         <p>由于元学习模型天然的快速训练出好的模型，所以其主要用于小样本学习之中。元学习的论文中也大多将小样本学习任务作为论文实验。</p>
         <h2><a id="2__9"></a>2 数据集</h2>
         <p>本文的复现用到的数据集小样本领域的通用数据集Omniglot，数据集的地址可以在我的github中找到<a href="https://github.com/miguealanmath/Datasets">omniglot_standard.zip</a>。<br> 以下引用<a href="https://www.imooc.com/article/258879" rel="nofollow">@心之宙</a>对omniglot的介绍:</p>
         <blockquote>
          <p>Omniglot 一般会被戏称为 MNIST 的转置，大家可以想想为什么？Omniglot 数据集包含来自 50个不同国家的字母表的 1623 个不同手写字符。每一个字符都是由 20个不同的人通过亚马逊的 Mechanical Turk 在线绘制的。<br> Omniglot 数据集总共包含 50个不同国家的字母表。我们通常将这些分成一组包含 30个字母表的背景（background）集和一组包含 20 个字母表的评估（evaluation）集。<br> 更具挑战性的表示学习任务是使用较小的背景集 “background small 1” 和 “background small 2”。每一个都只包含 5个字母, 更类似于一个成年人在学习一般的字符时可能遇到的经验。</p>
         </blockquote>
         <p>本文的复现主要基于omniglot的标准集。</p>
         <h2><a id="3__17"></a>3 代码分段详解</h2>
         <h3><a id="31__18"></a>3.1 数据预处理</h3>
         <p>首先对zip文件进行解压，解压后可以在python子文件夹中获得如下数据集：</p>
         <pre class="set-code-show"><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> os
<span class="token keyword">import</span> zipfile

root_path <span class="token operator">=</span> <span class="token string">'./../datasets'</span>
processed_folder <span class="token operator">=</span>  os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_path<span class="token punctuation">)</span>

zip_ref <span class="token operator">=</span> zipfile<span class="token punctuation">.</span>ZipFile<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_path<span class="token punctuation">,</span><span class="token string">'omniglot_standard.zip'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span>
zip_ref<span class="token punctuation">.</span>extractall<span class="token punctuation">(</span>root_path<span class="token punctuation">)</span>
zip_ref<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
         <div align="center"><img width="400" src="https://img-blog.csdnimg.cn/20200301191134647.png"></div><div align="center"></div> 然后对图片进行预处理 
         <pre class="set-code-show"><code class="prism language-python"><span class="token comment"># 数据预处理</span>
root_dir <span class="token operator">=</span> <span class="token string">'./../datasets/omniglot/python'</span>

<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image

<span class="token triple-quoted-string string">'''
an example of img_items:
( '0709_17.png',
  'Alphabet_of_the_Magi/character01',
  './../datasets/omniglot/python/images_background/Alphabet_of_the_Magi/character01')
'''</span>
<span class="token keyword">def</span> <span class="token function">find_classes</span><span class="token punctuation">(</span>root_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    img_items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>root<span class="token punctuation">,</span> dirs<span class="token punctuation">,</span> files<span class="token punctuation">)</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>root_dir<span class="token punctuation">)</span><span class="token punctuation">:</span> 
        <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"png"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                r <span class="token operator">=</span> root<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
                img_items<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> r<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> r<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"== Found %d items "</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>img_items<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> img_items

<span class="token comment">## 构建一个词典{class:idx}</span>
<span class="token keyword">def</span> <span class="token function">index_classes</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">:</span>
    class_idx <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> items<span class="token punctuation">:</span>
        <span class="token keyword">if</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">not</span> <span class="token keyword">in</span> class_idx<span class="token punctuation">:</span>
            class_idx<span class="token punctuation">[</span>item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> count
            count <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'== Found {} classes'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>class_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> class_idx
        

img_items <span class="token operator">=</span>  find_classes<span class="token punctuation">(</span>root_dir<span class="token punctuation">)</span>
class_idx <span class="token operator">=</span> index_classes<span class="token punctuation">(</span>img_items<span class="token punctuation">)</span>


temp <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> imgname<span class="token punctuation">,</span> classes<span class="token punctuation">,</span> dirs <span class="token keyword">in</span> img_items<span class="token punctuation">:</span>
    img <span class="token operator">=</span> <span class="token string">'{}/{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>dirs<span class="token punctuation">,</span> imgname<span class="token punctuation">)</span>
    label <span class="token operator">=</span> class_idx<span class="token punctuation">[</span>classes<span class="token punctuation">]</span>
    transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">lambda</span> img<span class="token punctuation">:</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token keyword">lambda</span> img<span class="token punctuation">:</span> img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token keyword">lambda</span> img<span class="token punctuation">:</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token keyword">lambda</span> img<span class="token punctuation">:</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token keyword">lambda</span> img<span class="token punctuation">:</span> img<span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">.</span>
                              <span class="token punctuation">]</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> transform<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token keyword">if</span> label <span class="token keyword">in</span> temp<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        temp<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        temp<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>img<span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'begin to generate omniglot.npy'</span><span class="token punctuation">)</span>
<span class="token comment">## 移除标签信息，每个标签包含20个样本</span>
img_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> label<span class="token punctuation">,</span> imgs <span class="token keyword">in</span> temp<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    img_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>imgs<span class="token punctuation">)</span><span class="token punctuation">)</span>
img_list <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img_list<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token comment"># [[20 imgs],..., 1623 classes in total]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'data shape:{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>img_list<span class="token punctuation">.</span>shape<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># (1623, 20, 1, 28, 28)</span>
temp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_dir<span class="token punctuation">,</span> <span class="token string">'omniglot.npy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> img_list<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end.'</span><span class="token punctuation">)</span>
</code></pre>
         <h3><a id="33__104"></a>3.3 构造训练集和测试集</h3>
         <pre class="set-code-show"><code class="prism language-python">img_list <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_dir<span class="token punctuation">,</span> <span class="token string">'omniglot.npy'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># (1623, 20, 1, 28, 28)</span>
x_train <span class="token operator">=</span> img_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1200</span><span class="token punctuation">]</span>
x_test <span class="token operator">=</span> img_list<span class="token punctuation">[</span><span class="token number">1200</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
num_classes <span class="token operator">=</span> img_list<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
datasets <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'train'</span><span class="token punctuation">:</span> x_train<span class="token punctuation">,</span> <span class="token string">'test'</span><span class="token punctuation">:</span> x_test<span class="token punctuation">}</span>
</code></pre>
         <p>然后我们需要将构造一个批量迭代出数据的迭代器，重要部分的实现代码如下：</p>
         <pre class="set-code-show"><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">next</span><span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Gets next batch from the dataset with name.
    :param mode: The name of the splitting (one of "train", "val", "test")
    :return:
    """</span>
    <span class="token comment"># update cache if indexes is larger than len(data_cache)</span>
    <span class="token keyword">if</span> indexes<span class="token punctuation">[</span>mode<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>datasets_cache<span class="token punctuation">[</span>mode<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        indexes<span class="token punctuation">[</span>mode<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        datasets_cache<span class="token punctuation">[</span>mode<span class="token punctuation">]</span> <span class="token operator">=</span> load_data_cache<span class="token punctuation">(</span>datasets<span class="token punctuation">[</span>mode<span class="token punctuation">]</span><span class="token punctuation">)</span>

    next_batch <span class="token operator">=</span> datasets_cache<span class="token punctuation">[</span>mode<span class="token punctuation">]</span><span class="token punctuation">[</span>indexes<span class="token punctuation">[</span>mode<span class="token punctuation">]</span><span class="token punctuation">]</span>
    indexes<span class="token punctuation">[</span>mode<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token keyword">return</span> next_batch
</code></pre>
         <h3><a id="32_BaseLearner_132"></a>3.2 构造Base-Learner</h3>
         <p>由于代码较多，这里只展示重要的代码:</p>
         <pre class="set-code-show"><code class="prism language-python"><span class="token keyword">if</span> params <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    params <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token builtin">vars</span>

weight<span class="token punctuation">,</span> bias <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 第1个CONV层</span>
x <span class="token operator">=</span> F<span class="token punctuation">.</span>conv2d<span class="token punctuation">(</span>x<span class="token punctuation">,</span> weight<span class="token punctuation">,</span> bias<span class="token punctuation">,</span> stride <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> padding <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>

weight<span class="token punctuation">,</span> bias <span class="token operator">=</span> params<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>  <span class="token comment"># 第1个BN层</span>
running_mean<span class="token punctuation">,</span> running_var <span class="token operator">=</span> self<span class="token punctuation">.</span>vars_bn<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>vars_bn<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
x <span class="token operator">=</span> F<span class="token punctuation">.</span>batch_norm<span class="token punctuation">(</span>x<span class="token punctuation">,</span> running_mean<span class="token punctuation">,</span> running_var<span class="token punctuation">,</span> weight<span class="token operator">=</span>weight<span class="token punctuation">,</span>bias <span class="token operator">=</span>bias<span class="token punctuation">,</span> training<span class="token operator">=</span> bn_training<span class="token punctuation">)</span>
x <span class="token operator">=</span> F<span class="token punctuation">.</span>max_pool2d<span class="token punctuation">(</span>x<span class="token punctuation">,</span>kernel_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment">#第1个MAX_POOL层  </span>
x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">,</span> inplace <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">#第1个relu</span>
</code></pre>
         <p>CONV 层-&gt; BN 层 -&gt; POOL层 -&gt; ReLU层，以上四个层组成一个块，然后将四个类似的块堆叠起来，结尾接一个Flatten层和一个Linear层。</p>
         <h3><a id="MetaLearner_148"></a>构造Meta-Learner</h3>
         <p>以下是Meta-Learner的代码，包括一个测试用的finetunning函数。</p>
         <pre class="set-code-show"><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MetaLearner</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MetaLearner<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>update_step <span class="token operator">=</span> <span class="token number">5</span> <span class="token comment">## task-level inner update steps</span>
        self<span class="token punctuation">.</span>update_step_test <span class="token operator">=</span> <span class="token number">5</span>  
        self<span class="token punctuation">.</span>net <span class="token operator">=</span> BaseNet<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>meta_lr <span class="token operator">=</span> <span class="token number">2e</span><span class="token operator">-</span><span class="token number">4</span>
        self<span class="token punctuation">.</span>base_lr <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">2</span>
        self<span class="token punctuation">.</span>inner_lr <span class="token operator">=</span> <span class="token number">0.4</span>
        self<span class="token punctuation">.</span>outer_lr <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">2</span>
        self<span class="token punctuation">.</span>meta_optim <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr <span class="token operator">=</span> self<span class="token punctuation">.</span>meta_lr<span class="token punctuation">)</span>
        
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x_spt<span class="token punctuation">,</span> y_spt<span class="token punctuation">,</span> x_qry<span class="token punctuation">,</span> y_qry<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 初始化</span>
        task_num<span class="token punctuation">,</span> ways<span class="token punctuation">,</span> shots<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w <span class="token operator">=</span> x_spt<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
        query_size <span class="token operator">=</span> x_qry<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 75 = 15 * 5</span>
        loss_list_qry <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>update_step <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        correct_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>update_step <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>task_num<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">## 第0步更新</span>
            y_hat <span class="token operator">=</span> self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>x_spt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> params <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> bn_training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># (ways * shots, ways)</span>
            loss <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y_spt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> 
            grad <span class="token operator">=</span> torch<span class="token punctuation">.</span>autograd<span class="token punctuation">.</span>grad<span class="token punctuation">(</span>loss<span class="token punctuation">,</span> self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            tuples <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>grad<span class="token punctuation">,</span> self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">## 将梯度和参数\theta一一对应起来</span>
            <span class="token comment"># fast_weights这一步相当于求了一个\theta - \alpha*\nabla(L)</span>
            fast_weights <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> p<span class="token punctuation">:</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>base_lr <span class="token operator">*</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tuples<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># 在query集上测试，计算准确率</span>
            <span class="token comment"># 这一步使用更新前的数据</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                y_hat <span class="token operator">=</span> self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>x_qry<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bn_training <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
                loss_qry <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y_qry<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                loss_list_qry<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> loss_qry
                pred_qry <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># size = (75)</span>
                correct <span class="token operator">=</span> torch<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>pred_qry<span class="token punctuation">,</span> y_qry<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                correct_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> correct
            
            <span class="token comment"># 使用更新后的数据在query集上测试。</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                y_hat <span class="token operator">=</span> self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>x_qry<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> fast_weights<span class="token punctuation">,</span> bn_training <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
                loss_qry <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y_qry<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                loss_list_qry<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> loss_qry
                pred_qry <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># size = (75)</span>
                correct <span class="token operator">=</span> torch<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>pred_qry<span class="token punctuation">,</span> y_qry<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                correct_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> correct   
            
            <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>update_step<span class="token punctuation">)</span><span class="token punctuation">:</span>
                
                y_hat <span class="token operator">=</span> self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>x_spt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> params <span class="token operator">=</span> fast_weights<span class="token punctuation">,</span> bn_training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
                loss <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y_spt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                grad <span class="token operator">=</span> torch<span class="token punctuation">.</span>autograd<span class="token punctuation">.</span>grad<span class="token punctuation">(</span>loss<span class="token punctuation">,</span> fast_weights<span class="token punctuation">)</span>
                tuples <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>grad<span class="token punctuation">,</span> fast_weights<span class="token punctuation">)</span> 
                fast_weights <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> p<span class="token punctuation">:</span> p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>base_lr <span class="token operator">*</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tuples<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    
                y_hat <span class="token operator">=</span> self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>x_qry<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> params <span class="token operator">=</span> fast_weights<span class="token punctuation">,</span> bn_training <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
                loss_qry <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y_qry<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                loss_list_qry<span class="token punctuation">[</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> loss_qry
                
                <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    pred_qry <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                    correct <span class="token operator">=</span> torch<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>pred_qry<span class="token punctuation">,</span> y_qry<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    correct_list<span class="token punctuation">[</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> correct
<span class="token comment">#         print('hello')</span>
                
        loss_qry <span class="token operator">=</span> loss_list_qry<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> task_num
        self<span class="token punctuation">.</span>meta_optim<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 梯度清零</span>
        loss_qry<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>meta_optim<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        accs <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>correct_list<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>query_size <span class="token operator">*</span> task_num<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>loss_list_qry<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span> task_num<span class="token punctuation">)</span>
        <span class="token keyword">return</span> accs<span class="token punctuation">,</span>loss

    
    
    <span class="token keyword">def</span> <span class="token function">finetunning</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x_spt<span class="token punctuation">,</span> y_spt<span class="token punctuation">,</span> x_qry<span class="token punctuation">,</span> y_qry<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>x_spt<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span>
        
        query_size <span class="token operator">=</span> x_qry<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        correct_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>update_step_test <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        
        new_net <span class="token operator">=</span> deepcopy<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">)</span>
        y_hat <span class="token operator">=</span> new_net<span class="token punctuation">(</span>x_spt<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y_spt<span class="token punctuation">)</span>
        grad <span class="token operator">=</span> torch<span class="token punctuation">.</span>autograd<span class="token punctuation">.</span>grad<span class="token punctuation">(</span>loss<span class="token punctuation">,</span> new_net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        fast_weights <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> p<span class="token punctuation">:</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>base_lr <span class="token operator">*</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>grad<span class="token punctuation">,</span> new_net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 在query集上测试，计算准确率</span>
        <span class="token comment"># 这一步使用更新前的数据</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            y_hat <span class="token operator">=</span> new_net<span class="token punctuation">(</span>x_qry<span class="token punctuation">,</span>  params <span class="token operator">=</span> new_net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bn_training <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
            pred_qry <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># size = (75)</span>
            correct <span class="token operator">=</span> torch<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>pred_qry<span class="token punctuation">,</span> y_qry<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            correct_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> correct

        <span class="token comment"># 使用更新后的数据在query集上测试。</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            y_hat <span class="token operator">=</span> new_net<span class="token punctuation">(</span>x_qry<span class="token punctuation">,</span> params <span class="token operator">=</span> fast_weights<span class="token punctuation">,</span> bn_training <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
            pred_qry <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># size = (75)</span>
            correct <span class="token operator">=</span> torch<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>pred_qry<span class="token punctuation">,</span> y_qry<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            correct_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> correct

        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>update_step_test<span class="token punctuation">)</span><span class="token punctuation">:</span>
            y_hat <span class="token operator">=</span> new_net<span class="token punctuation">(</span>x_spt<span class="token punctuation">,</span> params <span class="token operator">=</span> fast_weights<span class="token punctuation">,</span> bn_training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            loss <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> y_spt<span class="token punctuation">)</span>
            grad <span class="token operator">=</span> torch<span class="token punctuation">.</span>autograd<span class="token punctuation">.</span>grad<span class="token punctuation">(</span>loss<span class="token punctuation">,</span> fast_weights<span class="token punctuation">)</span>
            fast_weights <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> p<span class="token punctuation">:</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>base_lr <span class="token operator">*</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>grad<span class="token punctuation">,</span> fast_weights<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            y_hat <span class="token operator">=</span> new_net<span class="token punctuation">(</span>x_qry<span class="token punctuation">,</span> fast_weights<span class="token punctuation">,</span> bn_training<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                pred_qry <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>y_hat<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
                correct <span class="token operator">=</span> torch<span class="token punctuation">.</span>eq<span class="token punctuation">(</span>pred_qry<span class="token punctuation">,</span> y_qry<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
                correct_list<span class="token punctuation">[</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> correct
                
        <span class="token keyword">del</span> new_net
        accs <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>correct_list<span class="token punctuation">)</span> <span class="token operator">/</span> query_size
        <span class="token keyword">return</span> accs      
</code></pre>
         <h2><a id="4__270"></a>4 全部源码</h2>
         <p>你可以在我的github中找到全部源码。github账号：miguealanmath<br> <a href="https://github.com/miguealanmath/MAML-Pytorch">传送门</a></p>
         <h2><a id="5__273"></a>5 实验结果</h2>
         <p>我跑了6万轮，但是测试集上最高的准确率只有92%，而作者的论文中达到了98%。很多外国网友也复现了MAML，普遍的印象是，最终的准确率会比作者报告的98%略低几个百分点。同时在训练过程中，MAML多次出现了训练数据过拟合的现象。这应该也是最终在测试集上准确率较低的原因。</p>
         <p>有兴趣的朋友可以多调参试试。</p>
         <p>PS: 这篇文章的更新可以查看我的另一篇<a href="https://blog.csdn.net/wangkaidehao/article/details/105507809">博客</a></p></div>
        <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/editerView/markdown_views-f23dff6052.css" rel="stylesheet">
        <link href="https://csdnimg.cn/release/blogv2/dist/mdeditor/css/style-c216769e99.css" rel="stylesheet"></div>
      </article></div>
    </main></div><div class="recommend-right align-items-stretch clearfix" id="rightAside" data-type="recommend"></div></div>
  <link rel="stylesheet" href="https://csdnimg.cn/release/blog_editor_html/release1.6.12/ckeditor/plugins/codesnippet/lib/highlight/styles/github-gist.css">
 </body>
</html>